# MatCarv AWS Infrastructure as Code

Este reposit√≥rio cont√©m a infraestrutura como c√≥digo (IaC) usando Terraform para provisionar uma arquitetura completa na AWS.

## Arquitetura

A infraestrutura provisiona os seguintes recursos:

### Rede
- **VPC**: 192.168.1.0/24
- **Subnets P√∫blicas**: 2 subnets em AZs diferentes
- **Subnets Privadas**: 2 subnets em AZs diferentes
- **Internet Gateway**: Para acesso √† internet das subnets p√∫blicas
- **NAT Gateways**: 2 NAT Gateways para acesso √† internet das subnets privadas
- **Route Tables**: Configuradas para roteamento adequado

### Computa√ß√£o
- **EC2**: Inst√¢ncia t3a.small com Auto Scaling Group
- **Launch Template**: Configurado com Ubuntu 22.04 LTS
- **EBS**: Volume criptografado com KMS
- **User Data**: Instala√ß√£o e configura√ß√£o do Apache HTTP Server

### Banco de Dados
- **RDS MySQL**: Inst√¢ncia db.t4g.small
- **Criptografia**: Habilitada com KMS
- **Backup**: Reten√ß√£o de 7 dias
- **Multi-AZ**: Configurado para alta disponibilidade
- **Enhanced Monitoring**: Habilitado

### Load Balancer
- **Application Load Balancer (ALB)**: Distribui√ß√£o de tr√°fego
- **Target Group**: Configurado para inst√¢ncias EC2
- **Health Checks**: Monitoramento da sa√∫de das inst√¢ncias
- **SSL/TLS**: Certificado wildcard *.matcarv.com.br via ACM
- **Redirecionamento**: HTTP (80) ‚Üí HTTPS (443)
- **Access Logs**: Habilitado para bucket S3 matcarv-logs

### Armazenamento e Logs
- **S3 Bucket**: matcarv-logs para armazenar logs do ALB e CloudTrail
- **Criptografia S3**: AES256 server-side encryption
- **Lifecycle Policy**: Reten√ß√£o de 90 dias para logs
- **Versionamento**: Habilitado com reten√ß√£o de 30 dias para vers√µes antigas

### Auditoria e Monitoramento
- **CloudTrail**: Auditoria completa de API calls
- **CloudWatch Logs**: Logs do CloudTrail com reten√ß√£o de 30 dias
- **CloudWatch Dashboard**: Painel de monitoramento da infraestrutura
- **CloudWatch Alarms**: Alertas para m√©tricas cr√≠ticas
- **CloudWatch Agent**: Monitoramento detalhado de EC2 (CPU, mem√≥ria, disco)
- **KMS Encryption**: Logs do CloudTrail criptografados
- **Multi-Region**: CloudTrail configurado para todas as regi√µes
- **Data Events**: Monitoramento de eventos S3

### DNS
- **Route53**: Registro A para app.matcarv.com.br
- **Alias**: Apontando para o ALB

### Seguran√ßa
- **Security Groups**: Configurados com acesso restritivo
  - ALB: Acesso p√∫blico nas portas 80 e 443
  - EC2: Acesso apenas do ALB na porta 80
  - RDS: Acesso apenas do EC2 na porta 3306
- **KMS Keys**: Chaves separadas para EBS e RDS
- **IAM Roles**: Para monitoramento do RDS
- **SSL Certificate**: Certificado wildcard gerenciado pelo ACM

## Pr√©-requisitos

1. **Terraform**: Vers√£o >= 1.0
2. **AWS CLI**: Configurado com o profile `matcarv`
3. **Zona Route53**: `matcarv.com.br` deve existir na conta AWS
4. **Certificado SSL**: Certificado wildcard `*.matcarv.com.br` deve estar dispon√≠vel no ACM **na regi√£o us-east-1 (Norte da Virg√≠nia)**
5. **Remote State**: Bucket S3 e tabela DynamoDB para armazenar o estado do Terraform

### ‚ö†Ô∏è Importante sobre o Certificado SSL
O certificado SSL deve estar na mesma regi√£o da infraestrutura (us-east-1). Se voc√™ possui o certificado em outra regi√£o:

1. **Op√ß√£o 1**: Solicitar um novo certificado na regi√£o us-east-1
2. **Op√ß√£o 2**: Alterar a regi√£o da infraestrutura para onde o certificado existe
3. **Op√ß√£o 3**: Temporariamente comentar as configura√ß√µes HTTPS no `alb.tf` para deploy inicial

### üóÑÔ∏è Remote State
Este projeto utiliza **Remote State** com backend S3 para:
- **Armazenar o estado**: Bucket S3 `matcarv-terraform-state`
- **Controle de concorr√™ncia**: Tabela DynamoDB `matcarv-terraform-locks`
- **Seguran√ßa**: Estado criptografado e versionado

## Configura√ß√£o

1. Clone o reposit√≥rio:
```bash
git clone <repository-url>
cd matcarv-aws-iac
```

2. Configure o Remote State (primeira vez apenas):
```bash
./setup-remote-state.sh
```

3. Copie o arquivo de vari√°veis de exemplo:
```bash
cp terraform.tfvars.example terraform.tfvars
```

4. Edite o arquivo `terraform.tfvars` conforme necess√°rio.

## Deploy

1. Inicialize o Terraform:
```bash
terraform init
```

2. Valide a configura√ß√£o:
```bash
terraform validate
```

3. Visualize o plano de execu√ß√£o:
```bash
terraform plan
```

4. Aplique a infraestrutura:
```bash
terraform apply
```

## Remote State

### üóÑÔ∏è Configura√ß√£o do Backend Remoto
Este projeto utiliza **S3 Backend** para armazenar o estado do Terraform de forma segura e colaborativa:

#### **Recursos do Remote State:**
- **Bucket S3**: `matcarv-terraform-state`
  - Versionamento habilitado
  - Criptografia AES256
  - Acesso p√∫blico bloqueado
- **Tabela DynamoDB**: `matcarv-terraform-locks`
  - Controle de concorr√™ncia
  - Preven√ß√£o de conflitos em equipe
  - Locking autom√°tico durante opera√ß√µes

#### **Benef√≠cios:**
- ‚úÖ **Colabora√ß√£o**: M√∫ltiplos desenvolvedores podem trabalhar no mesmo projeto
- ‚úÖ **Seguran√ßa**: Estado criptografado e versionado
- ‚úÖ **Backup**: Hist√≥rico completo de mudan√ßas
- ‚úÖ **Locking**: Previne opera√ß√µes simult√¢neas conflitantes
- ‚úÖ **Auditoria**: Rastreamento de todas as modifica√ß√µes

#### **Configura√ß√£o Inicial:**
```bash
# Execute apenas uma vez para configurar o backend
./setup-remote-state.sh
```

#### **Migra√ß√£o do Estado Local:**
Se voc√™ j√° tem um estado local, o Terraform perguntar√° se deseja migrar:
```bash
terraform init
# Responda 'yes' quando perguntado sobre migra√ß√£o
```

#### **‚ö†Ô∏è Importante:**
- Execute `setup-remote-state.sh` **apenas uma vez** por projeto
- Mantenha o bucket S3 e tabela DynamoDB seguros
- **Nunca delete** estes recursos sem fazer backup do estado
- O estado cont√©m informa√ß√µes sens√≠veis (senhas, chaves, etc.)

## Acesso √† Aplica√ß√£o

Ap√≥s o deploy, a aplica√ß√£o estar√° dispon√≠vel em:
- **URL HTTPS**: https://app.matcarv.com.br
- **URL HTTP**: http://app.matcarv.com.br (redireciona para HTTPS)
- **Load Balancer**: Distribui o tr√°fego entre as inst√¢ncias EC2

## Monitoramento

### üìä CloudWatch Dashboard
A infraestrutura inclui um dashboard completo do CloudWatch com:

#### **M√©tricas do EC2:**
- **CPU Utilization**: Monitoramento de uso de CPU das inst√¢ncias
- **Memory Utilization**: Uso de mem√≥ria (via CloudWatch Agent)
- **Network In/Out**: Tr√°fego de rede das inst√¢ncias
- **Disk Usage**: Utiliza√ß√£o de disco

#### **M√©tricas do RDS:**
- **CPU Utilization**: Uso de CPU do banco de dados
- **Database Connections**: N√∫mero de conex√µes ativas
- **Free Storage Space**: Espa√ßo livre em disco
- **Read/Write IOPS**: Opera√ß√µes de I/O por segundo
- **Read/Write Latency**: Lat√™ncia de opera√ß√µes de leitura/escrita

#### **M√©tricas do ALB:**
- **Request Count**: N√∫mero de requisi√ß√µes
- **Target Response Time**: Tempo de resposta dos targets
- **Healthy/Unhealthy Hosts**: Status dos hosts

#### **M√©tricas do Auto Scaling:**
- **Group Desired Capacity**: Capacidade desejada
- **Group In Service Instances**: Inst√¢ncias em servi√ßo
- **Group Total Instances**: Total de inst√¢ncias

### üö® CloudWatch Alarms
Alarmes configurados para m√©tricas cr√≠ticas:

- **EC2 High CPU**: Alerta quando CPU > 80%
- **RDS High CPU**: Alerta quando CPU do RDS > 80%
- **RDS Low Storage**: Alerta quando storage < 2GB
- **ALB High Response Time**: Alerta quando tempo de resposta > 1s
- **ALB Unhealthy Hosts**: Alerta quando h√° hosts n√£o saud√°veis

### üìà CloudWatch Agent
As inst√¢ncias EC2 incluem o CloudWatch Agent para monitoramento detalhado:
- **M√©tricas de Sistema**: CPU, mem√≥ria, disco, rede
- **M√©tricas Customizadas**: Namespace CWAgent
- **Coleta Autom√°tica**: Intervalo de 5 minutos
- **Permiss√µes IAM**: Role dedicada para envio de m√©tricas

### üîó Acesso ao Dashboard
Ap√≥s o deploy, acesse o dashboard em:
```
https://us-east-1.console.aws.amazon.com/cloudwatch/home?region=us-east-1#dashboards:name=matcarv-infrastructure-dashboard
```

## Seguran√ßa

### Criptografia
- **EBS**: Volumes criptografados com KMS
- **RDS**: Banco de dados criptografado com KMS
- **Backups**: Backups autom√°ticos criptografados
- **SSL/TLS**: Certificado wildcard para comunica√ß√£o segura

### Rede
- **Subnets Privadas**: EC2 e RDS em subnets privadas
- **Security Groups**: Acesso altamente restritivo
  - RDS acess√≠vel apenas pelo EC2
  - EC2 acess√≠vel apenas pelo ALB
  - ALB acess√≠vel publicamente apenas nas portas 80/443
- **NAT Gateways**: Acesso seguro √† internet para recursos privados

### Certificado SSL
- **Wildcard Certificate**: *.matcarv.com.br gerenciado pelo ACM
- **Redirecionamento HTTP**: Todo tr√°fego HTTP √© redirecionado para HTTPS
- **SSL Policy**: ELBSecurityPolicy-TLS-1-2-2017-01

## Custos Estimados

Os principais componentes de custo incluem:
- EC2 t3a.small: ~$15/m√™s
- RDS db.t4g.small: ~$25/m√™s
- ALB: ~$22/m√™s
- NAT Gateways: ~$46/m√™s (2 gateways)
- EBS e outros: ~$15/m√™s

**Total estimado**: ~$123/m√™s

> üìä **Calculadora Interativa**: Abra o arquivo `cost-estimation.html` no seu navegador para uma estimativa detalhada e interativa dos custos com gr√°ficos din√¢micos.

> Use a [Calculadora de Pre√ßos AWS](https://calculator.aws) para estimativas mais precisas.

## Calculadora de Custos Interativa

### üí∞ Estimativa Din√¢mica de Custos
A infraestrutura inclui uma calculadora interativa de custos (`cost-estimation.html`) com:

#### **üìä Recursos da Calculadora:**
- **Gr√°ficos Din√¢micos**: Visualiza√ß√£o em tempo real dos custos
- **Configura√ß√£o Interativa**: Ajuste de par√¢metros da infraestrutura
- **Proje√ß√µes**: Custos mensais, anuais, di√°rios e por hora
- **Detalhamento**: Breakdown completo por recurso
- **Responsiva**: Funciona em desktop e mobile

#### **üéõÔ∏è Controles Dispon√≠veis:**
- **N√∫mero de Inst√¢ncias EC2**: 1-10 inst√¢ncias
- **Tipo de Inst√¢ncia EC2**: t3a.small at√© t3a.xlarge
- **Tipo de Inst√¢ncia RDS**: db.t4g.small at√© db.t4g.xlarge
- **Armazenamento RDS**: 20GB at√© 1TB

#### **üìà Gr√°ficos Inclu√≠dos:**
- **Pizza**: Distribui√ß√£o de custos por servi√ßo
- **Linha**: Proje√ß√£o de custos ao longo de 12 meses
- **Tabela**: Detalhamento completo por recurso

#### **üí° Como Usar:**
1. Abra o arquivo `cost-estimation.html` no navegador
2. Ajuste os par√¢metros conforme sua necessidade
3. Visualize os custos atualizados em tempo real
4. Use as informa√ß√µes para planejamento de or√ßamento

#### **üéØ Recursos Monitorados:**
- EC2 Instances (Auto Scaling)
- RDS MySQL Database
- Application Load Balancer
- NAT Gateways (2x)
- Elastic IPs (2x)
- S3 Bucket (Logs)
- CloudTrail
- CloudWatch (Dashboard + Alarms)
- KMS Keys (3x)
- Route53 Hosted Zone

## Limpeza

Para destruir toda a infraestrutura:
```bash
terraform destroy
```

## Estrutura de Arquivos

```
.
‚îú‚îÄ‚îÄ README.md                 # Este arquivo
‚îú‚îÄ‚îÄ main.tf                   # Configura√ß√£o do provider e data sources
‚îú‚îÄ‚îÄ vpc.tf                    # VPC, Subnets, Gateways e Roteamento
‚îú‚îÄ‚îÄ variables.tf              # Defini√ß√£o de vari√°veis
‚îú‚îÄ‚îÄ outputs.tf                # Outputs da infraestrutura
‚îú‚îÄ‚îÄ security_groups.tf        # Security Groups
‚îú‚îÄ‚îÄ kms.tf                    # Chaves KMS para criptografia
‚îú‚îÄ‚îÄ ec2.tf                    # Configura√ß√£o do EC2 e Auto Scaling
‚îú‚îÄ‚îÄ rds.tf                    # Configura√ß√£o do RDS MySQL
‚îú‚îÄ‚îÄ alb.tf                    # Application Load Balancer e SSL
‚îú‚îÄ‚îÄ route53.tf                # Configura√ß√£o do Route53
‚îú‚îÄ‚îÄ s3.tf                     # Bucket S3 para logs
‚îú‚îÄ‚îÄ cloudtrail.tf             # CloudTrail e CloudWatch Logs
‚îú‚îÄ‚îÄ cloudwatch.tf             # Dashboard e Alarms do CloudWatch
‚îú‚îÄ‚îÄ cost-estimation.html      # Calculadora interativa de custos
‚îú‚îÄ‚îÄ setup-remote-state.sh     # Script para configurar Remote State
‚îú‚îÄ‚îÄ terraform.tfvars.example  # Exemplo de vari√°veis
‚îî‚îÄ‚îÄ .gitignore               # Arquivos ignorados pelo Git
```

## Vari√°veis Principais

| Vari√°vel | Descri√ß√£o | Valor Padr√£o |
|----------|-----------|--------------|
| `aws_region` | Regi√£o AWS | `us-east-1` |
| `project_name` | Nome do projeto | `matcarv` |
| `vpc_cidr` | CIDR da VPC | `192.168.1.0/24` |
| `instance_type` | Tipo da inst√¢ncia EC2 | `t3a.small` |
| `db_instance_class` | Classe da inst√¢ncia RDS | `db.t4g.small` |
| `domain_name` | Nome do dom√≠nio | `app.matcarv.com.br` |

## Troubleshooting

### Problemas Comuns

1. **Profile AWS n√£o encontrado**:
   - Verifique se o profile `matcarv` est√° configurado no AWS CLI

2. **Zona Route53 n√£o encontrada**:
   - Certifique-se de que a zona `matcarv.com.br` existe na sua conta AWS

3. **Certificado SSL n√£o encontrado**:
   - Verifique se o certificado wildcard `*.matcarv.com.br` est√° dispon√≠vel no ACM
   - O certificado deve estar na mesma regi√£o da infraestrutura

4. **Limites de recursos**:
   - Verifique os limites da sua conta AWS para VPCs, EIPs, etc.

## Contribui√ß√£o

1. Fork o projeto
2. Crie uma branch para sua feature
3. Commit suas mudan√ßas
4. Push para a branch
5. Abra um Pull Request

## Licen√ßa

Este projeto est√° sob a licen√ßa MIT. Veja o arquivo LICENSE para mais detalhes.